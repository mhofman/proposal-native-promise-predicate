---
routerMode: hash # for GH hosting
theme: default
title: Native promise predicate for Stage 1 or 2
info: |
  Proposal for exposing a native promise predicate
class: text-center
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade
fonts:
  local: ["Consolas", "Fira Code", "monospace"]
layout: cover
---

# Native promise predicate <br /> for Stage 1 (or 2)

Mathieu Hofman (@mhofman)

---

# Motivation

Native promises are recognized and don't use `.then` in some operations.

<v-click>

Native promises

```js {hide|1-4|*|*|*|5}{at: 1}
const promise = Promise.resolve(42);
typeof promise.then === 'function';

const v = await promise; // does not call promise.then
Promise.resolve(promise) === promise; // pass-through
```

</v-click>

<div v-click="3">

Thenables

```js {1-3|*|4}{at:4}
const thenable = { then(onFulfilled) { onFulfilled(42) } };

const v = await thenable; // does call thenable.then
Promise.resolve(thenable) !== thenable; // does not pass-through, calls thenable.then, allocates new promise
```

</div>

<div v-click="5">

--> Cannot build a side-effect-free predicate

</div>

---

# Precedents

<v-clicks>

* `Error.isError`
  * pure brand check
  * implies some stack information is associated
* `Array.isArray`
  * pierces proxy
  * indicates when object treated as array, e.g. in `JSON.serialize`

</v-clicks>

---

# Proposal

Predicate that cleanly exposes `IsPromise` AO

<v-clicks>

* `Promise.isPromise` ?

* `Promise.isNativePromise` ?

* Some other less ergonomic but clean brand check ?

</v-clicks>

<v-click>

## Membrane transparency

<v-clicks at="5">

* Predicate does not pierce proxies
  * Like `Error.isError`
* It's already possible to brand check promises with side-effects
* It's better for membranes to create a new native promise (pass by copy)
  * Need a predicate to know which thenables are native promises

</v-clicks>

</v-click>

---
layout: section
---
# Stage 1?

<br/>

Predicate for native promises

---
layout: section
---
# Stage 2?

<br/>

`Promise.isXXX()`

[Spec text](https://mhofman.github.io/proposal-native-promise-predicate/)

`isPromise` ? `isNativePromise` ?